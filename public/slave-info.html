<dom-module id="slave-info">
	<template>
		<div class="ui hidden divider"></div>

		<div class="ui container">

			<h1 class="ui centered header">
				<i is="platform-icon" platform="{{platform}}"></i>
				{{hostname}}
			</h1>

			<h2 class="ui header">Disk usage</h2>
			<div class="ui green progress">
				<div class="bar" style$="transition: 300ms; -webkit-transition: 300ms; width: {{ usedPercentageAt(drives, 0) }}%;">
					<div class="progress">{{ usedPercentageAt(drives, 0) }}% used</div>
				</div>
			</div>

			<h2 class="ui header">System info</h2>
			<table class="ui table">
				<thead>
				<tr>
					<th>Architecture</th>
					<th>Cores</th>
					<th>Platform</th>
				</tr>
				</thead>
				<tbody>
				<td>{{arch}}</td>
				<td>{{cpuCount}}</td>
				<td>{{platform}}</td>
				</tbody>
			</table>

			<h2 class="ui header">Tasks</h2>
			<div class="ui labeled icon ls button"><i class="ui folder icon"></i>List directory</div>
			<div on-click="showAlert" class="ui labeled icon showAlert button"><i class="ui announcement icon"></i>Show alert</div>
			<div class="ui labeled icon ps button"><i class="ui list layout icon"></i>Show active processes</div>

			<template is="dom-if" if="{{alertButtonWasPushed}}">
				<div class="ui icon message">
					<i class$="{{messageIcon}}"></i>
					<i on-click="closeMessage" class="close icon"></i>
					<div class="content">
						<div class="header">{{messageTitle}}</div>
						<p>{{messageContent}}</p>
					</div>
				</div>
			</template>

		</div>
	</template>

	<script>
		Polymer({
			is: 'slave-info',
			properties: {
				_id: String,
				address: String,
				connected: Boolean,
				arch: String,
				cpuCount: Number,
				drives: Array,
				hostname: String,
				platform: String,
				alertButtonWasPushed: Boolean,
				messageTitle: String,
				messageContent: String,
				messageIcon: String
			},
			usedPercentage(disk) {
				if (disk) {
					var {total, available, used} = disk
					return parseFloat(total) == 0 ? 0 : Math.round(parseFloat(used) / parseFloat(total) * 10000)/100
				}
			},
			usedPercentageAt(disks, index) {
				return this.usedPercentage(disks[index])
			},
			showAlert(e) {
				var self = this
				this.alertButtonWasPushed = true
				this.messageTitle = 'Hold tight!'
				this.messageContent = "We're awaiting client response..."
				this.messageIcon = 'big smile loading icon'

				Meteor.call('showDialog', this.address, function(error, result) {
					console.log("meteor method!")
					if(result) {
						self.messageTitle = 'Client answered'
						self.messageContent = `The client answered "${result['text returned']}" and pushed the button: "${	result['button returned']}"`
						self.messageIcon = 'ui big call icon'
					} else {
						console.log("false")
						self.messageTitle = 'Client rejected the dialog'
						self.messageContent = 'The client has canceled the operation'
						self.messageIcon = 'ui big frown icon'
					}
					console.log(self.message)
				})
			},
			closeMessage(e) {
				this.alertButtonWasPushed = false
			},
			attached() {
				var self = this
				self._slavesTracker = Tracker.autorun(function() {
					var slave = Slaves.findOne(FlowRouter.getParam('id'))
					self.id = slave._id;
					self.address = slave.address;
					_.forEach(slave.os, function(value, key) {
						self[key] = value
					})
				})
				this.alertButtonWasPushed = false
			},
			detached() {
				this._slavesTracker.stop()
			}
		})
	</script>
</dom-module>